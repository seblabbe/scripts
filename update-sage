#!/bin/bash
# This script updates Sage and run make ptestlong only if a new develop version
# is available on github
# WARNING: Use it at your own risk because I know it does not always work well...
# Author: Sebastien Labbe, 16 dec 2015

# Remove Macports from PATH
PATH=`echo $PATH | sed -e 's/\/opt\/local\/sbin://'`
PATH=`echo $PATH | sed -e 's/\/opt\/local\/bin://'`
#echo $PATH

SAGE_ROOT=$HOME/Applications/sage-git
cd $SAGE_ROOT

# Check if there are uncommitted changes
# http://stackoverflow.com/questions/2657935
# http://stackoverflow.com/questions/3878624
if [[ -z $(git status --porcelain) ]]
then
  echo "update-sage: tree is clean"
else
  echo "update-sage: Error: tree is dirty, please commit changes or stash them before running this"
  exit 1
fi

git checkout develop
git fetch github develop

# Check if a pull is needed in git
# http://stackoverflow.com/questions/3258243/check-if-pull-needed-in-git
LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse @{u})
BASE=$(git merge-base @ @{u})
echo "update-sage: Local Branch: " $LOCAL
echo "update-sage: Remote Branch:" $REMOTE
echo "update-sage: Base Branch:  " $BASE
if [ $LOCAL = $REMOTE ]; then
    echo "update-sage: Local develop branch is up-to-date with github, we will re-build sage anyway"
elif [ $LOCAL = $BASE ]; then
    echo "update-sage: Local develop branch is behind github/develop, we need to pull"
    git pull github develop
    # git merge FETCH_HEAD # or equivalently ?
elif [ $REMOTE = $BASE ]; then
    echo "update-sage: Error: Local develop branch has commits not in github/develop."
    exit 1
else
    echo "update-sage: Error: Local develop branch has diverged from github/develop."
    exit 1
fi

# Get the number of cpus
NCPUS=`sage -c "print(sage.parallel.ncpus.ncpus())"`
# another option is : sage -python src/bin/sage-num-threads.py
# which outputs 1 2 2

# Build Sage
make doc-clean
rm -rf logs
export MAKE="make -j$NCPUS"
make start
export MAKE="make -j1"
make doc
export MAKE="make -j$NCPUS"
./sage -t -p --all --long --logfile=logs/ptestlong.log #make ptestlong

# make doc is:
# cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log
# make ptestlong is:
# ./sage -t -p --all --long --logfile=logs/ptestlong.log

#TODO: clean branches merged into sage
# http://stackoverflow.com/questions/6127328/how-can-i-delete-all-git-branches-which-have-been-merged 

